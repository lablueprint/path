create table donations (
  donation_id uuid default uuid_generate_v4 () primary key, -- generated by default
  date_submitted timestamp with time zone default current_timestamp, -- generated by default
  donor_is_individual boolean not null, -- required, used if donor is an individual
  donor_individual_name text, -- optional, used if donor is an individual
  donor_business_name text, -- optional, used if donor is a business
  donor_business_contact_name text, -- optional, used if donor is a business
  donor_email varchar(255) not null, -- can't store more than 255 characters
  donor_phone varchar(20), -- optional, can't store more than 20 characters
  donor_street_address text, -- optional, street address
  donor_receive_mailings boolean not null, -- required, whether or not donor wants to receive mailings
  donor_receive_emails boolean not null, -- required, whether or not donor wants to receive emails
  donor_remain_anonymous boolean not null, -- required, whether or not donor wants to remain anonymous
  estimated_value numeric not null, -- required, estimated value of donation in USD
  items_donated text not null, -- required, free-text description of items
  receiver_first_name text not null, --required, first name of the person receiving the donation
  receiver_last_name text not null, -- required, last name of the person receiving the donation
  store_name text, -- optional, name of the store receiving the donation
  store_street_address text -- optional, address of the store receiving the donation 
);

alter table donations enable row level security;

alter table donations
add constraint ck_estimated_value check (estimated_value >= 0);

alter table "donations"
add constraint ck_donor_individual_name_presence check (
  (
    donor_is_individual = true
    and donor_individual_name is not null
  )
  or (
    donor_is_individual = false
    and donor_individual_name is null
  )
);

alter table "donations"
add constraint ck_donor_business_name_presence check (
  (
    donor_is_individual = true
    and donor_business_name is null
  )
  or (
    donor_is_individual = false
    and donor_business_name is not null
  )
);

alter table "donations"
add constraint ck_donor_business_contact_name_presence check (
  (
    donor_is_individual = true
    and donor_business_contact_name is null
  )
  or (
    donor_is_individual = false
    and donor_business_contact_name is not null
  )
);

create policy "auth can read donations if >= admin" on public.donations for
select
  to authenticated using (
    (
      select
        auth.jwt ()
    ) ->> 'user_role' in ('admin', 'superadmin', 'owner')
  );

create policy "auth can insert donations if >= admin" on public.donations for insert to authenticated
with
  check (
    (
      select
        auth.jwt ()
    ) ->> 'user_role' in ('admin', 'superadmin', 'owner')
  );

create policy "auth can update donations if >= superadmin" on public.donations
for update
  to authenticated using (
    (
      select
        auth.jwt ()
    ) ->> 'user_role' in ('superadmin', 'owner')
  )
with
  check (
    (
      select
        auth.jwt ()
    ) ->> 'user_role' in ('superadmin', 'owner')
  );

create policy "auth can delete donations if >= superadmin" on public.donations for delete to authenticated using (
  (
    select
      auth.jwt ()
  ) ->> 'user_role' in ('superadmin', 'owner')
);
